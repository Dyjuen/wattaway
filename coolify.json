{
  "build": {
    "type": "laravel",
    "php_version": "8.3",
    "node_version": "22"
  },
  "deploy": {
    "type": "git",
    "branch": "main"
  },
  "services": [
    {
      "name": "app",
      "type": "laravel",
      "environment": [
        "APP_URL=https://wattaway.cloud",
        "DB_CONNECTION=mysql",
        "DB_HOST=mysql",
        "DB_DATABASE=wattaway",
        "DB_USERNAME=wattaway_user",
        "DB_PASSWORD=",
        "CACHE_STORE=redis",
        "QUEUE_CONNECTION=redis",
        "SESSION_DRIVER=redis",
        "REDIS_HOST=redis",
        "NODE_VERSION=22",
        "LOG_CHANNEL=stack",
        "LOG_DEPRECATIONS_CHANNEL=null",
        "LOG_LEVEL=error"
      ],
      "environment_runtime_only": [
        "APP_ENV=production",
        "APP_DEBUG=false"
      ],
      "build_command": "composer install --no-dev --optimize-autoloader && npm ci && npm run build",
      "start_command": "php artisan serve --host=0.0.0.0 --port=8000",
      "post_deployment_command": "sleep 30 && echo 'Starting post-deployment setup...' && php artisan key:generate --force && echo 'Key generated, running migrations...' && php artisan migrate --force --seed && echo 'Migrations completed, setting permissions...' && ./setup-permissions.sh && echo 'Permissions set, caching...' && php artisan config:cache && php artisan route:cache && php artisan view:cache && echo 'Post-deployment setup completed successfully!'",
      "restart": "unless-stopped",
      "healthcheck": {
        "test": ["CMD", "curl", "-f", "http://localhost:8000/health"],
        "interval": "30s",
        "timeout": "10s",
        "retries": 5,
        "start_period": "40s"
      }
    },
    {
      "name": "mysql",
      "type": "mysql",
      "version": "8.0",
      "environment": [
        "MYSQL_DATABASE=wattaway",
        "MYSQL_USER=wattaway_user",
        "MYSQL_ALLOW_EMPTY_PASSWORD=yes"
      ]
    },
    {
      "name": "redis",
      "type": "redis",
      "version": "7.0"
    }
  ],
  "domains": [
    {
      "domain": "wattaway.cloud",
      "service": "app"
    }
  ]
}
