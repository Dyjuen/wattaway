[phases.setup]
nixPkgs = ["nodejs-22_x", "php83", "php83Extensions.pdo_mysql", "php83Extensions.redis", "php83Extensions.mbstring", "php83Extensions.xml", "php83Extensions.curl", "nginx", "supervisor"]

[phases.install]
cmds = [
    "composer install --no-dev --optimize-autoloader",
    "npm ci"
]

[phases.build]
cmds = [
    "npm run build"
]

[start]
cmd = "supervisord -c /assets/supervisord.conf"

[staticAssets]
"supervisord.conf" = '''
[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
logfile=/tmp/supervisord.log
logfile_maxbytes=50MB
logfile_backups=2
loglevel=info
pidfile=/tmp/supervisord.pid
nodaemon=true
minfds=1024
minprocs=200

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[include]
files = /assets/worker-*.conf
'''

"worker-web.conf" = '''
[program:web]
process_name=%(program_name)s_%(process_num)02d
command=php artisan serve --host=0.0.0.0 --port=${PORT:-8000}
autostart=true
autorestart=true
stdout_logfile=/tmp/web.log
stderr_logfile=/tmp/web.log
'''

"worker-queue.conf" = '''
[program:queue]
process_name=%(program_name)s_%(process_num)02d
command=php artisan queue:work --sleep=3 --tries=3
autostart=false
autorestart=true
stdout_logfile=/tmp/queue.log
stderr_logfile=/tmp/queue.log
'''